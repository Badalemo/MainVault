/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var f=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var y=Object.prototype.hasOwnProperty;var S=(c,l)=>{for(var e in l)f(c,e,{get:l[e],enumerable:!0})},w=(c,l,e,s)=>{if(l&&typeof l=="object"||typeof l=="function")for(let t of b(l))!y.call(c,t)&&t!==e&&f(c,t,{get:()=>l[t],enumerable:!(s=p(l,t))||s.enumerable});return c};var x=c=>w(f({},"__esModule",{value:!0}),c);var D={};S(D,{default:()=>m});module.exports=x(D);var C=require("obsidian");var u=require("obsidian"),g=class extends u.PluginSettingTab{constructor(e,s){super(e,s);this.plugin=s}display(){let{containerEl:e}=this;e.empty(),new u.Setting(e).setName("\u62D6\u5C3E\u5F00\u5173 Trail enable").setDesc("\u662F\u5426\u542F\u7528\u62D6\u5C3E").addToggle(s=>s.setValue(this.plugin.setting.enableTrail).onChange(async t=>{this.plugin.setting.enableTrail=t,await this.plugin.saveSettings()})),new u.Setting(e).setName("\u62D6\u5C3E\u989C\u8272 Trail color").setDesc("\u8BBE\u7F6E\u62D6\u5C3E\u989C\u8272").addColorPicker(s=>{s.setValue(this.plugin.setting.trailColor).onChange(async t=>{this.plugin.setting.trailColor=t,await this.plugin.saveSettings()})}),new u.Setting(e).setName("\u62D6\u5C3E\u901F\u5EA6 Trail speed").setDesc("\u8BBE\u7F6E\u62D6\u5C3E\u66F4\u65B0\u6B21\u6570\uFF0C\u8D8A\u5927\u8D8A\u6162 More Bigger,More Slower").addText(s=>{s.inputEl.type="number",s.setPlaceholder("\u989C\u8272\u5B57\u7B26\u4E32\u6216\u989C\u8272\u4EE3\u7801").setValue(this.plugin.setting.trailStep.toString()).onChange(async t=>{this.plugin.setting.trailStep=parseInt(t),await this.plugin.saveSettings()})})}};var T={trailStep:30,enableTrail:!0,trailColor:"#78dce8"},m=class extends C.Plugin{constructor(){super(...arguments);this.observer=null;this.settingObserver=null;this.isMouseMove=!1;this.isMouseDown=!1;this.isDomChanged=!1;this.lastPos={x:0,y:0,height:0};this.rectangle={x:0,y:0,dirX:0,dirY:0,extTarget:0,extOrigin:0};this.isScroll=!1;this.isInited=!1;this.isFirstTrail=!0;this.isSpanChange=!1;this.focus=!0;this.closeSettings=!1}async onload(){await this.loadSettings(),this.addSettingTab(new g(this.app,this)),this.app.workspace.onLayoutReady(()=>{this.app.workspace.on("file-open",e=>{e===null?(this.isInited=!1,this.isFirstTrail=!0,this.cursor=null,this.canvas=null,this.trailCount=0):this.isInited||this.init()}),this.init()})}onunload(){var e,s;(e=this.cursor)==null||e.remove(),(s=this.canvas)==null||s.remove(),this.stopObserving()}init(){if(this.editorDom=document.querySelector(".cm-editor"),!this.editorDom){console.error("\u672A\u6253\u5F00\u6587\u6863");return}this.isInited=!0,this.cursor=this.app.workspace.containerEl.createDiv({cls:"smooth-cursor-busyo"}),this.cursor.id="smooth-cursor-busyo",this.editorDom.appendChild(this.cursor),this.delayedFrames(()=>{let e=document.querySelectorAll("style"),s="smooth-cursor-busyo";for(let t=0;t<e.length;t++){let n=e[t];if(n.textContent.includes(s)){this.customStyle=n;break}}},10),this.createTrail(),this.setting.enableTrail||this.cursor.addClass("show"),this.registerDomEvent(this.editorDom,"mousedown",e=>{this.isMouseDown=!0;let s=this.editorDom.ownerDocument.getSelection();if(s&&s.rangeCount>0){let t=s.getRangeAt(0);this.endOffset=t.endOffset;let n=t.cloneRange();n.setStart(t.endContainer,t.endOffset),n.setEnd(t.endContainer,t.endOffset),this.endContainerRangeRect=n.getClientRects()[0],this.endContainerRangeRect||(this.endContainerRangeRect=t.endContainer.getBoundingClientRect())}this.updateCursor()}),this.registerDomEvent(this.editorDom,"mousemove",e=>{this.isMouseDown&&(this.isMouseMove=!0,this.updateCursor())}),this.registerDomEvent(this.editorDom,"mouseup",()=>{this.isMouseDown=!1,this.isMouseMove=!1}),this.registerDomEvent(this.editorDom,"keydown",()=>{this.isDomChanged||this.updateCursor()}),this.registerDomEvent(this.editorDom,"keyup",()=>{this.isDomChanged||this.updateCursor()}),this.registerEvent(this.app.workspace.on("resize",()=>{this.canvas&&(this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight),this.isScroll=!0,this.updateCursor()})),this.registerDomEvent(this.editorDom.querySelector(".cm-scroller"),"scroll",()=>{this.isScroll=!0,this.updateCursor()}),this.lastPos=this.getCursorPosition(),this.startObserving(),this.registerEvent(this.app.workspace.on("active-leaf-change",e=>{var s,t;e&&e.view.containerEl.contains(this.editorDom)?(this.focus=!0,document.body.addClass("caret-hide"),(s=this.cursor)==null||s.addClass("show")):(this.focus=!1,document.body.removeClass("caret-hide"),(t=this.cursor)==null||t.removeClass("show"))})),document.body.addClass("caret-hide")}updateCursor(e=null){if(!this.cursor||!this.customStyle)return;this.closeSettings=!1;let s;e?s=e:s=this.getCursorPosition();let t=window.scrollX||document.documentElement.scrollLeft,n=window.scrollY||document.documentElement.scrollTop;this.isScroll?this.cursor.addClass("noTrans"):this.cursor.removeClass("noTrans");let i=this.customStyle.textContent.replace(/(--cursor-x:\s*[^;]+;)/,`--cursor-x: ${s.x+t};`);if(i=i.replace(/(--cursor-y:\s*[^;]+;)/,`--cursor-y: ${s.y+n};`),i=i.replace(/(--cursor-height:\s*[^;]+;)/,`--cursor-height: ${s.height};`),this.customStyle.textContent=i,this.setting.enableTrail&&!this.isScroll&&(this.lastPos.x!=s.x||this.lastPos.y!=s.y)&&this.updateTrail(this.lastPos.x,this.lastPos.y,s.x,s.y,s.height,this.lastPos.height),this.setting.enableTrail&&this.cursor.hasClass("noAni")?this.cursor.removeClass("noAni"):this.setting.enableTrail||(this.cursor.addClass("noAni"),setTimeout(()=>{var r;(r=this.cursor)==null||r.removeClass("noAni")},80)),this.lastPos=s,this.isDomChanged&&!this.isMouseMove&&this.isSpanChange){let r=window.getSelection();if(r&&r.rangeCount>0){let o=r.getRangeAt(0),a=o.startContainer,h=o.endContainer,d=a.textContent.length>0&&o.startOffset>0,v=h.textContent.length>0&&o.endOffset<h.textContent.length;d?(r.modify("move","backward","character"),r.modify("move","forward","character")):v&&(r.modify("move","forward","character"),r.modify("move","backward","character"))}}this.isScroll=!1,this.isDomChanged=!1,this.isSpanChange=!1}getCursorPosition(){let e=document.getSelection();if(e&&e.rangeCount>0){let s=this.editorDom.getBoundingClientRect(),t=e.getRangeAt(0).cloneRange(),n=t.startContainer,i=t.endContainer;if(!this.isMouseMove&&!this.isDomChanged)t.setStart(i,t.endOffset),t.setEnd(i,t.endOffset);else if(this.endContainerRangeRect){let o=t.cloneRange();o.setStart(i,t.endOffset),o.setEnd(i,t.endOffset);let a=o.getClientRects()[0];if(a||(a=i.getBoundingClientRect()),a.top>this.endContainerRangeRect.top)t.setStart(i,t.endOffset),t.setEnd(i,t.endOffset);else if(o.setStart(n,t.startOffset),o.setEnd(n,t.startOffset),a=o.getClientRects()[0],a||(a=n.getBoundingClientRect()),a.top<this.endContainerRangeRect.top)t.setStart(n,t.startOffset),t.setEnd(n,t.startOffset);else if(o.endOffset>this.endOffset){let h=i.textContent?i.textContent.length:0,d=h>o.endOffset?o.endOffset:h;t.setStart(i,d),t.setEnd(i,d)}else t.setStart(n,o.startOffset),t.setEnd(n,o.startOffset)}let r=t.getClientRects()[0];return r||(r=t.endContainer.getBoundingClientRect()),{x:r.x+window.scrollX-s.x,y:r.y+window.scrollY-s.y,height:r.height}}return{x:0,y:0,height:0}}startObserving(){let e=document.querySelector(".cm-contentContainer");for(;!e;)e=document.querySelector(".cm-contentContainer");this.observer=new MutationObserver(s=>{let t=!1;for(let n of s)if(n.type==="childList"){for(let i=0;i<n.addedNodes.length;i++)n.addedNodes[i].nodeName!="BR"&&(t=!0,n.addedNodes[i].nodeName=="SPAN"&&(this.isSpanChange=!0));for(let i=0;i<n.removedNodes.length;i++)n.removedNodes[i].nodeName!="BR"&&(t=!0,n.removedNodes[i].nodeName=="SPAN"&&(this.isSpanChange=!0))}t&&(this.isDomChanged=!0,this.delayedFrames(()=>{this.updateCursor()}))}),this.settingObserver=new MutationObserver(s=>{var t;for(let n of s)if(n.type==="childList"){for(let i=0;i<n.addedNodes.length;i++)if(n.addedNodes[i].nodeName=="DIV"&&n.addedNodes[i].classList.contains("modal-container")){this.focus=!1,document.body.removeClass("caret-hide"),(t=this.cursor)==null||t.removeClass("show");break}for(let i=0;i<n.removedNodes.length;i++)if(n.removedNodes[i].nodeName=="DIV"&&n.removedNodes[i].classList.contains("modal-container")){this.focus=!0,document.body.addClass("caret-hide"),this.closeSettings=!0;break}}}),this.observer.observe(e,{childList:!0,subtree:!0}),this.settingObserver.observe(document.body,{childList:!0,subtree:!0})}stopObserving(){var e,s;(e=this.observer)==null||e.disconnect(),this.observer=null,(s=this.settingObserver)==null||s.disconnect(),this.settingObserver=null}delayedFrames(e,s=2){let t=0;function n(){t++,t===s?e():requestAnimationFrame(n)}requestAnimationFrame(n)}createTrail(){let e=this;this.canvas=this.editorDom.createEl("canvas",{cls:"smooth-cursor-busyo-canvas"}),this.canvas.id="trail-canvas";let s=this.canvas.getContext("2d");this.canvas.width=this.editorDom.innerWidth,this.canvas.height=this.editorDom.innerHeight;function t(){if(e.canvas===null||s===null)return;if(e.cursor&&e.trailCount<=0){s.clearRect(0,0,e.canvas.width,e.canvas.height),e.focus&&!e.closeSettings&&e.cursor.addClass("show");return}e.trailCount--;let i=e.trailCount/e.setting.trailStep,r=e.rectangle.x-e.rectangle.dirX*.15*Math.max(0,-.3+i),o=r,a=e.rectangle.x-e.rectangle.dirX*i,h=a;e.rectangle.dirX===3?(r=e.rectangle.x,o=r,a=e.rectangle.x-e.rectangle.dirX,h=a):e.rectangle.dirY<0?(o=e.rectangle.x-e.rectangle.dirX*.05*Math.max(0,-.3+i),a=e.rectangle.x-e.rectangle.dirX*Math.max(0,i-.02)):e.rectangle.dirY>0&&(r=e.rectangle.x-e.rectangle.dirX*.05*Math.max(0,-.3+i),h=e.rectangle.x-e.rectangle.dirX*Math.max(0,i-.02));let d=e.rectangle.extTarget-e.rectangle.extOrigin;s.clearRect(0,0,e.canvas.width,e.canvas.height),s.beginPath(),s.moveTo(r,e.rectangle.y+e.rectangle.extTarget),s.lineTo(o,e.rectangle.y),s.lineTo(a,e.rectangle.y-e.rectangle.dirY*i),s.lineTo(h,e.rectangle.y-e.rectangle.dirY*i+e.rectangle.extTarget-d*i),s.closePath(),s.fillStyle=e.setting.trailColor,s.fill()}function n(){e.canvas!==null&&(t(),requestAnimationFrame(n))}n()}updateTrail(e,s,t,n,i,r){if(this.cursor===null)return;if(this.isFirstTrail){this.isFirstTrail=!1,this.cursor.addClass("show");return}let o=t-e,a=n-s;this.rectangle.x=t,this.rectangle.y=n,this.rectangle.dirX=o==0?3:o,this.rectangle.dirY=a,this.rectangle.extTarget=i,this.rectangle.extOrigin=r,this.trailCount=this.setting.trailStep,this.cursor.removeClass("show")}async loadSettings(){this.setting=Object.assign({},T,await this.loadData())}async saveSettings(){await this.saveData(this.setting)}updateSetting(){this.cursor}};

/* nosourcemap */